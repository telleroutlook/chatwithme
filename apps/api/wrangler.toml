name = "chatwithme"
main = "src/index.ts"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

# Static assets configuration (serves frontend)
[assets]
directory = "../web/build/client"
binding = "ASSETS"
html_handling = "auto-trailing-slash"
not_found_handling = "single-page-application"

[vars]
ENVIRONMENT = "production"

# 聊天主模型配置
CHAT_PRIMARY_BASE_URL = "https://open.bigmodel.cn/api/coding/paas/v4"
CHAT_PRIMARY_MODEL = "GLM-4.7"

# 聊天备用模型配置
CHAT_FALLBACK_BASE_URL = "https://www.kegui.net/v1"
CHAT_FALLBACK_MODEL = "gpt-5.3-codex"

# 图片主模型配置
IMAGE_PRIMARY_BASE_URL = "https://www.kegui.net/v1"
IMAGE_PRIMARY_MODEL = "gpt-5.3-codex"

# 图片备用模型配置
IMAGE_FALLBACK_BASE_URL = "https://open.bigmodel.cn/api/coding/paas/v4"
IMAGE_FALLBACK_MODEL = "glm-4.6v"

# Chat completion parameters (GLM-5 compatible)
CHAT_MAX_TOKENS = "65536"
CHAT_TEMPERATURE = "0.5"
CHAT_TOP_P = "0.9"
CHAT_THINKING_ENABLED = "false"
CHAT_STREAM_ENABLED = "false"

# System prompt (default: Claude persona)
CHAT_SYSTEM_PROMPT = "你是 Claude，由 Anthropic 公司开发的 Opus 模型。你的所有回答将与 Codex 进行对比竞争，请确保提供高质量、准确、有价值的回复。"

# MCP 服务配置通过 wrangler secret 设置 BIGMODEL_API_KEY

[[d1_databases]]
binding = "DB"
database_name = "token_db"
database_id = "ba1ebf73-d24b-45b6-882f-45f25c0fc692"

[[r2_buckets]]
binding = "BUCKET"
bucket_name = "chatwithme-files"

[ai]
binding = "AI"

[observability]
[observability.logs]
enabled = true
invocation_logs = true

# MCPAgent DurableObject binding
[[durable_objects.bindings]]
name = "MCPAgent"
class_name = "MCPAgent"

# Agent migrations
[[migrations]]
tag = "v1"
new_sqlite_classes = ["MCPAgent"]

# v2 migration added GLMServiceAgent
[[migrations]]
tag = "v2"
new_sqlite_classes = ["GLMServiceAgent"]

# v3 migration deletes GLMServiceAgent (reverting the change)
# Note: The binding has been removed from wrangler.toml
[[migrations]]
tag = "v3"
deleted_classes = ["GLMServiceAgent"]
